
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Develop for New Chain · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="PolyNetwork">
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-sectionx/sectionx.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-sharing-plus/all.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-sharing-plus/style.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-flexible-linkcard/flexible-linkcard.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-emphasize/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-flexible-alerts/style.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-lightbox/css/lightbox.min.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-alerts/style.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-prism/prism-okaidia.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-theme-hqbook/theme.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../../styles/website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../relayer/relayer.html" />
    
    
    <link rel="prev" href="../relay_chain/relay_chain_development.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="header-inner">
        <!-- LOGO -->
        <div class="logo">
            <img src="" alt="logo">
        </div>
        <span class="title"></span>

        <!-- Search -->
        
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>


        <!-- Nav -->
        <ul class="header-nav">
            <li>
                <a href="https://poly.network/" target="_blank">Home</a>
            </li><li>
                <a href="https://bridge.poly.network/" target="_blank">Poly Bridge</a>
            </li><li>
                <a href="https://explorer.poly.network/" target="_blank">Poly Explorer</a>
            </li>
        </ul>
    </div>

    <div class="book-summary">
        <!--<div class="book-summary-title">文档目录</div>-->
        
        
        <nav role="navigation">
            


<ul class="summary">
    
    

    

    
        
        <li class="header">Introduction</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    About Poly Network
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../guideline.html">
            
                <a href="../../guideline.html">
            
                    
                    Guidelines for Reading
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Development</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../readme.html">
            
                <a href="../readme.html">
            
                    
                    Connect New Chains
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="../relay_chain/relay_chain_development.html">
            
                <a href="../relay_chain/relay_chain_development.html">
            
                    
                    Develop for Poly Chain
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.1.2" data-path="contracts.html">
            
                <a href="contracts.html">
            
                    
                    Develop for New Chain
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="../relayer/relayer.html">
            
                <a href="../relayer/relayer.html">
            
                    
                    Develop for Relayer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4" data-path="../launch_and_test/launch.html">
            
                <a href="../launch_and_test/launch.html">
            
                    
                    Test and Launch
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../../new_product/integrate_bridge/readme.html">
            
                <a href="../../new_product/integrate_bridge/readme.html">
            
                    
                    Build New Bridges
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.2.1" data-path="../../new_product/integrate_bridge/bridge.html">
            
                <a href="../../new_product/integrate_bridge/bridge.html">
            
                    
                    API
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../../new_product/integrate_assets/readme.html">
            
                <a href="../../new_product/integrate_assets/readme.html">
            
                    
                    Import New Assets
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.3.1" data-path="../../new_product/integrate_assets/token.html">
            
                <a href="../../new_product/integrate_assets/token.html">
            
                    
                    Import Token
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.2" data-path="../../new_product/integrate_assets/nft.html">
            
                <a href="../../new_product/integrate_assets/nft.html">
            
                    
                    Import NFT
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../../new_product/integrate_contracts/readme.html">
            
                <a href="../../new_product/integrate_contracts/readme.html">
            
                    
                    Customize Business Logic Contracts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.4.1" data-path="../../new_product/integrate_contracts/Customizing Business Logic Contract.html">
            
                <a href="../../new_product/integrate_contracts/Customizing Business Logic Contract.html">
            
                    
                    Guidelines for Developing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4.2" data-path="../../new_product/integrate_contracts/launch.html">
            
                <a href="../../new_product/integrate_contracts/launch.html">
            
                    
                    Test and Launch
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">User Manuals</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../../Core_Smart_Contract/User_Manuals/Token_Transaction.html">
            
                <a href="../../Core_Smart_Contract/User_Manuals/Token_Transaction.html">
            
                    
                    Token Transaction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../../Core_Smart_Contract/User_Manuals/NFT_Transaction.html">
            
                <a href="../../Core_Smart_Contract/User_Manuals/NFT_Transaction.html">
            
                    
                    NFT Transaction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../../Core_Smart_Contract/User_Manuals/Transaction_Acceleration.html">
            
                <a href="../../Core_Smart_Contract/User_Manuals/Transaction_Acceleration.html">
            
                    
                    Transaction Acceleration
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Appendix</li>
        
        
    
        <li class="chapter " data-level="4.1" >
            
                <span>
            
                    
                    Contracts
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="../../Core_Smart_Contract/Contract/CCD.html">
            
                <a href="../../Core_Smart_Contract/Contract/CCD.html">
            
                    
                    CCD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="../../Core_Smart_Contract/Contract/CCM.html">
            
                <a href="../../Core_Smart_Contract/Contract/CCM.html">
            
                    
                    CCM
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3" data-path="../../Core_Smart_Contract/Contract/CCMP.html">
            
                <a href="../../Core_Smart_Contract/Contract/CCMP.html">
            
                    
                    CCMP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4" data-path="../../Core_Smart_Contract/Contract/LockProxy.html">
            
                <a href="../../Core_Smart_Contract/Contract/LockProxy.html">
            
                    
                    LockProxy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5" data-path="../../Core_Smart_Contract/Contract/NFTLockProxy.html">
            
                <a href="../../Core_Smart_Contract/Contract/NFTLockProxy.html">
            
                    
                    NFTLockProxy
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../../Core_Smart_Contract/Nodes/Nodes.html">
            
                <a href="../../Core_Smart_Contract/Nodes/Nodes.html">
            
                    
                    Nodes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../../Core_Smart_Contract/Chain_ID/Chain_ID.html">
            
                <a href="../../Core_Smart_Contract/Chain_ID/Chain_ID.html">
            
                    
                    Chain ID
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="../../GLOSSARY.html">
            
                <a href="../../GLOSSARY.html">
            
                    
                    Glossary
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">FAQ</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../../FAQ/template.html">
            
                <a href="../../FAQ/template.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


        </nav>
        
        
    </div>

    <!-- Content nav -->
    <div class="book-anchor">
        <!--<div class="book-anchor-title">在这篇文章中:</div>-->
        <div class="book-anchor-body">

        </div>
    </div>

    <div class="book-body">
        
        <div class="body-inner">
            
            

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Develop for New Chain</a>
    </h1>
</div>




            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                    
<div id="book-search-results">
    <div class="search-noresults">
    
                    <section class="normal markdown-section">
                        
                        <h1 align="center" id="develop-for-new-chain">Develop for New Chain</h1>

<p>The development of a new chain mainly involves developing cross-chain modules. Here, the cross-chain module works as a set of <strong>smart contracts</strong>. </p>
<p>In some cases, it can also work as a native blockchain module. 
To help you develop it, here we offer examples in Solidity for each main method. 
You may refer to the complete <a href="https://github.com/polynetwork/eth-contracts/blob/master/contracts/core/cross_chain_manager" target="_blank">code</a> of these contracts.</p>
<blockquote>
<p>[!Note|style:flat|label:Notice]
If the chain integrated to Poly Network supports EVM, you could freely use our cross-chain contracts as templates. If not, you may need to develop your contracts that contain the main features as shown in the following guidelines. </p>
</blockquote>
<h2 id="1-introduction-to-cross-chain-contracts">1. Introduction to Cross-chain Contracts</h2>
<p>In this part, we sort the contracts into <strong>data</strong>, <strong>logic</strong>, and <strong>proxy</strong> contracts to complete the cross-chain contracts. You could either follow the methods listed below or choose other ways for your project.</p>
<ul>
<li>List of contracts: <ul>
<li><a href="https://github.com/polynetwork/eth-contracts/blob/master/contracts/core/cross_chain_manager/logic/EthCrossChainManager.sol" target="_blank">Cross Chain Manager Contract</a>: On the <a href="../../GLOSSARY.html#source-chain" class="glossary-term" title="A public chain corresponds to the target chain where a particular asset firstly appears.">source chain</a>, it creates the cross-chain transactions transferred to the Poly. The <a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a> verifies the legitimacy of transactions and executes the method on the target business logic contract. It may be referred to as a CCM contract in the following context.</li>
<li><a href="https://github.com/polynetwork/eth-contracts/blob/master/contracts/core/cross_chain_manager/data/EthCrossChainData.sol" target="_blank">Cross Chain Data Contract</a>: It serves as a database of cross-chain transactions. It may be referred to as a CCD contract in the following context.</li>
<li><a href="https://github.com/polynetwork/eth-contracts/blob/master/contracts/core/cross_chain_manager/upgrade/EthCrossChainManagerProxy.sol" target="_blank">Cross Chain Manager Proxy Contract</a>: It serves as a proxy of the CCM contract. When there is any need to upgrade the CCM contract, it would pause the old CCM contract and set the new CCM contract to the CCD contract.</li>
<li>Business Logic Contract: It executes the business logic of cross-chain projects. It interacts with users and the CCM contract both on the source and target chains. We also offer the <a href="http://81.69.45.203/new_product/integrate_contracts/Customizing%20Business%20Logic%20Contract.html" target="_blank">guidelines</a> for developing a Business Logic Contract.</li>
</ul>
</li>
<li>Interactions among contracts</li>
</ul>
<div align="center"><a href="resources/contracts_interaction.png" data-lightbox="9e313b54-85aa-49f4-af97-97d327af5981" data-title=""><img src="resources/contracts_interaction.png" alt=""></a></div>

<h2 id="2-developing-ccm-contracts">2. Developing CCM Contracts</h2>
<p>Before customizing your CCM, you need to implement the four main features. </p>
<h3 id="step1-synchronizing-genesis-block-header">Step1. Synchronizing genesis block header</h3>
<p>This step is meant to implement the methods of synchronizing the genesis block header of the <a href="../../GLOSSARY.html#poly-chain" class="glossary-term" title="The relay chain in the cross-chain ecosystem. One of the crucial components of the cross-chain ecosystem. Each type of node is deployed and maintained by other individuals or organizations and has its unique governance and trust mechanism. The poly chain is responsible for connecting them, standardizing cross-chain data flow and interfaces, verifying the legitimacy of cross-chain data, etc.">Poly chain</a> to the CCM contract. </p>
<h4 id="example">Example:</h4>
<pre class="language-"><code class="lang-solidity"><span class="token comment">/*  @notice                       Sync Poly chain genesis block header to smart contract
 *  @dev                          This function can only be called once; nextbookkeeper of rawHeader can&apos;t be empty
 *  @param rawHeader              Poly chain genesis block raw header or raw Header including switching consensus peers info
 *  @return                       true or false
*/</span>
<span class="token keyword">function</span> <span class="token function">initGenesisBlock</span><span class="token punctuation">(</span><span class="token builtin">bytes</span> <span class="token keyword">memory</span> rawHeader<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> pubKeyList<span class="token punctuation">)</span> whenNotPaused <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Load Ethereum cross chain data contract</span>
    IEthCrossChainData eccd <span class="token operator">=</span> <span class="token function">IEthCrossChainData</span><span class="token punctuation">(</span>EthCrossChainDataAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Make sure the contract has not been initialized before</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>eccd<span class="token punctuation">.</span><span class="token function">getCurEpochConPubKeyBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;EthCrossChainData contract has already been initialized!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Parse header and convit the public keys into nextBookKeeper and compare it with header.nextBookKeeper to verify the validity of signature</span>
    ECCUtils<span class="token punctuation">.</span>Header <span class="token keyword">memory</span> header <span class="token operator">=</span> ECCUtils<span class="token punctuation">.</span><span class="token function">deserializeHeader</span><span class="token punctuation">(</span>rawHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token builtin">bytes20</span> nextBookKeeper<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> keepers<span class="token punctuation">)</span> <span class="token operator">=</span> ECCUtils<span class="token punctuation">.</span><span class="token function">verifyPubkey</span><span class="token punctuation">(</span>pubKeyList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>nextBookkeeper <span class="token operator">==</span> nextBookKeeper<span class="token punctuation">,</span> <span class="token string">&quot;NextBookers illegal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Record current epoch start height and public keys (by storing them in address format)</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>eccd<span class="token punctuation">.</span><span class="token function">putCurEpochStartHeight</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Save Poly chain current epoch start height to Data contract failed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>eccd<span class="token punctuation">.</span><span class="token function">putCurEpochConPubKeyBytes</span><span class="token punctuation">(</span>ECCUtils<span class="token punctuation">.</span><span class="token function">serializeKeepers</span><span class="token punctuation">(</span>keepers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Save Poly chain current epoch book keepers to Data contract failed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Fire the event</span>
    <span class="token keyword">emit</span> <span class="token function">InitGenesisBlockEvent</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>height<span class="token punctuation">,</span> rawHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>This method should be called initially and can <strong>only</strong> be called <strong>once</strong>. For the input data <code>rawHeader</code>, the <code>nextbookkeeper</code> can not be empty.</li>
<li>Firstly, this function checks the <strong>public key</strong> of the current epoch to make sure that the CCM contract is uninitialized.  </li>
<li>Then we will parse the raw header to get the <code>header.nextBookKeeper</code>. Comparing it with the <code>nextBookKeeper</code> converted from pubKeyList, we could verify the validity of the signature.</li>
<li>After verifying the signature, we could record the current epoch start height and the public keys by storing them in the address format. And then emit the event <code>InitGenesisBlockEvent</code>.   </li>
</ul>
<h3 id="step2-changing-consensus-validator">Step2. Changing consensus validator</h3>
<p>This step is meant to implement the methods of changing the <a href="../../GLOSSARY.html#poly-chain" class="glossary-term" title="The relay chain in the cross-chain ecosystem. One of the crucial components of the cross-chain ecosystem. Each type of node is deployed and maintained by other individuals or organizations and has its unique governance and trust mechanism. The poly chain is responsible for connecting them, standardizing cross-chain data flow and interfaces, verifying the legitimacy of cross-chain data, etc.">Poly Chain</a> consensus validator, which is called <code>BookKeeper</code> in the code. </p>
<h4 id="example">Example:</h4>
<pre class="language-"><code class="lang-solidity"><span class="token comment">/*  @notice                       change Poly chain consensus bookkeeper
 *  @param rawHeader              Poly chain change bookkeeper block raw header
 *  @param pubKeyList             Poly chain consensus nodes public key list
 *  @param sigList                Poly chain consensus nodes signature list
 *  @return                       true or false
*/</span>
<span class="token keyword">function</span> <span class="token function">changeBookKeeper</span><span class="token punctuation">(</span><span class="token builtin">bytes</span> <span class="token keyword">memory</span> rawHeader<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> pubKeyList<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> sigList<span class="token punctuation">)</span> whenNotPaused <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Load Ethereum cross chain data contract</span>
    ECCUtils<span class="token punctuation">.</span>Header <span class="token keyword">memory</span> header <span class="token operator">=</span> ECCUtils<span class="token punctuation">.</span><span class="token function">deserializeHeader</span><span class="token punctuation">(</span>rawHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    IEthCrossChainData eccd <span class="token operator">=</span> <span class="token function">IEthCrossChainData</span><span class="token punctuation">(</span>EthCrossChainDataAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Make sure rawHeader.height is higher than recorded current epoch start height</span>
    <span class="token builtin">uint64</span> curEpochStartHeight <span class="token operator">=</span> eccd<span class="token punctuation">.</span><span class="token function">getCurEpochStartHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>height <span class="token operator">&gt;</span> curEpochStartHeight<span class="token punctuation">,</span> <span class="token string">&quot;The height of header is lower than current epoch start height!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Ensure the rawHeader is the key header including info of switching consensus peers by containing non-empty nextBookKeeper field</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>nextBookkeeper <span class="token operator">!=</span> <span class="token builtin">bytes20</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;The nextBookKeeper of header is empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Verify signature of rawHeader comes from pubKeyList</span>
    <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> polyChainBKs <span class="token operator">=</span> ECCUtils<span class="token punctuation">.</span><span class="token function">deserializeKeepers</span><span class="token punctuation">(</span>eccd<span class="token punctuation">.</span><span class="token function">getCurEpochConPubKeyBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">uint</span> n <span class="token operator">=</span> polyChainBKs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>ECCUtils<span class="token punctuation">.</span><span class="token function">verifySig</span><span class="token punctuation">(</span>rawHeader<span class="token punctuation">,</span> sigList<span class="token punctuation">,</span> polyChainBKs<span class="token punctuation">,</span> n <span class="token operator">-</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Verify signature failed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Convert pubKeyList into Ethereum address format and make sure the compound address from the converted Ethereum addresses</span>
    <span class="token comment">// equals passed in header.nextBookKeeper</span>
    <span class="token punctuation">(</span><span class="token builtin">bytes20</span> nextBookKeeper<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> keepers<span class="token punctuation">)</span> <span class="token operator">=</span> ECCUtils<span class="token punctuation">.</span><span class="token function">verifyPubkey</span><span class="token punctuation">(</span>pubKeyList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>nextBookkeeper <span class="token operator">==</span> nextBookKeeper<span class="token punctuation">,</span> <span class="token string">&quot;NextBookers illegal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// update current epoch start height of Poly chain and current epoch consensus peers book keepers addresses</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>eccd<span class="token punctuation">.</span><span class="token function">putCurEpochStartHeight</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Save MC LatestHeight to Data contract failed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>eccd<span class="token punctuation">.</span><span class="token function">putCurEpochConPubKeyBytes</span><span class="token punctuation">(</span>ECCUtils<span class="token punctuation">.</span><span class="token function">serializeKeepers</span><span class="token punctuation">(</span>keepers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Save Poly chain book keepers bytes to Data contract failed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Fire the change book keeper event</span>
    <span class="token keyword">emit</span> <span class="token function">ChangeBookKeeperEvent</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>height<span class="token punctuation">,</span> rawHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>Firstly, you need to make sure the <code>rawHeader.height</code> is higher than recorded current epoch starts height. </li>
<li>Then you need to ensure that the <code>rawHeader</code> is the key header, including info of switching consensus peers by containing a non-empty <code>nextBookKeeper</code> field.</li>
<li>Analogous to <code>initGenesisBlock()</code>, we also need to parse the raw header to get the <code>header.nextBookKeeper</code>. Comparing it with the <code>nextBookKeeper</code> converted from pubKeyList, we could verify the validity of the signature.</li>
<li>After verifying the signature, we could record the current epoch start height and current epoch consensus peers bookkeepers by storing them in the address format. And then emit the event <code>ChangeBookKeeperEvent</code>.   </li>
</ul>
<h3 id="step3-pushing-transactions">Step3. Pushing transactions</h3>
<p>This step is meant to implement the methods of pushing the serialized cross-chain transaction information to the <a href="../../GLOSSARY.html#poly-chain" class="glossary-term" title="The relay chain in the cross-chain ecosystem. One of the crucial components of the cross-chain ecosystem. Each type of node is deployed and maintained by other individuals or organizations and has its unique governance and trust mechanism. The poly chain is responsible for connecting them, standardizing cross-chain data flow and interfaces, verifying the legitimacy of cross-chain data, etc.">Poly chain</a>.</p>
<h4 id="example">Example:</h4>
<pre class="language-"><code class="lang-solidity"><span class="token comment">/*  
 *  @param toChainId              The target chain id
 *  @param toAddress              The address in bytes format to receive the same amount of tokens in the target chain
 *  @param toContract             Target smart contract address in bytes in the target blockchain
 *  @param txData                 Transaction data for target chain, include toAssetHash, toAddress, amount
 *  @return                       true or false 
*/</span>
<span class="token keyword">function</span> <span class="token function">crossChain</span><span class="token punctuation">(</span><span class="token builtin">uint64</span> toChainId<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> toContract<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> method<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> txData<span class="token punctuation">)</span> whenNotPaused <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Only allow whitelist contract to call</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>whiteListFromContract<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">&quot;Invalid from contract&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Load Ethereum cross chain data contract</span>
    IEthCrossChainData eccd <span class="token operator">=</span> <span class="token function">IEthCrossChainData</span><span class="token punctuation">(</span>EthCrossChainDataAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// To help differentiate two txs, the ethTxHashIndex is increasing automatically</span>
    <span class="token builtin">uint256</span> txHashIndex <span class="token operator">=</span> eccd<span class="token punctuation">.</span><span class="token function">getEthTxHashIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Convert the uint256 into bytes</span>
    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> paramTxHash <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">uint256ToBytes</span><span class="token punctuation">(</span>txHashIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Construct the makeTxParam, and put the hash info storage, proving tx existence</span>
    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> rawParam <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>ZeroCopySink<span class="token punctuation">.</span><span class="token function">WriteVarBytes</span><span class="token punctuation">(</span>paramTxHash<span class="token punctuation">)</span><span class="token punctuation">,</span>
        ZeroCopySink<span class="token punctuation">.</span><span class="token function">WriteVarBytes</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span><span class="token function">sha256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> paramTxHash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ZeroCopySink<span class="token punctuation">.</span><span class="token function">WriteVarBytes</span><span class="token punctuation">(</span>Utils<span class="token punctuation">.</span><span class="token function">addressToBytes</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ZeroCopySink<span class="token punctuation">.</span><span class="token function">WriteUint64</span><span class="token punctuation">(</span>toChainId<span class="token punctuation">)</span><span class="token punctuation">,</span>
        ZeroCopySink<span class="token punctuation">.</span><span class="token function">WriteVarBytes</span><span class="token punctuation">(</span>toContract<span class="token punctuation">)</span><span class="token punctuation">,</span>
        ZeroCopySink<span class="token punctuation">.</span><span class="token function">WriteVarBytes</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">,</span>
        ZeroCopySink<span class="token punctuation">.</span><span class="token function">WriteVarBytes</span><span class="token punctuation">(</span>txData<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Must save it in the storage to be included in the proof to be verified.</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>eccd<span class="token punctuation">.</span><span class="token function">putEthTxHash</span><span class="token punctuation">(</span><span class="token function">keccak256</span><span class="token punctuation">(</span>rawParam<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Save ethTxHash by index to Data contract failed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Fire the cross chain event denoting there is a cross chain request from Ethereum network to other public chains through Poly chain network</span>
    <span class="token keyword">emit</span> <span class="token function">CrossChainEvent</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> paramTxHash<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> toChainId<span class="token punctuation">,</span> toContract<span class="token punctuation">,</span> rawParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>Only the contracts in the <strong>whitelist</strong> can call this method.</li>
<li>When a cross-chain function is carried out interact, it creates cross-chain transactions invoked by service contracts the logic cont.</li>
<li>This method constructs the <code>rawParam</code>, which contains <strong>transaction hash</strong>, <code>msg.sender</code>, <strong><a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a> ID</strong>, <strong>business logic contract</strong> to be invoked on <a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a>, the <strong>target method</strong> to be invoked, and the <strong>serialized transaction data</strong> which has been already constructed in the business logic contract. </li>
<li>Then put the hash of <code>rawParam</code> into storage, proving the existence of the transaction.</li>
</ul>
<h3 id="step4-verifying--executing">Step4. Verifying &amp; executing</h3>
<p>This step is meant to implement the methods of verifying the block header and Merkle proof. If passing the verification, the transaction could be executed on the <a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a>.</p>
<h4 id="example">Example:</h4>
<pre class="language-"><code class="lang-solidity"><span class="token comment">/*  
 *  @param proof                  Poly chain transaction Merkle proof
 *  @param rawHeader              The header containing crossStateRoot to verify the above tx Merkle proof
 *  @param headerProof            The header Merkle proof used to verify rawHeader
 *  @param curRawHeader           Any header in current epoch consensus of Poly chain
 *  @param headerSig              The converted signature variable for solidity derived from Poly chain consensus nodes&apos; signature 
 *                                used to verify the validity of curRawHeader
 *  @return                       true or false
*/</span>
<span class="token keyword">function</span> <span class="token function">verifyHeaderAndExecuteTx</span><span class="token punctuation">(</span><span class="token builtin">bytes</span> <span class="token keyword">memory</span> proof<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> rawHeader<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> headerProof<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> curRawHeader<span class="token punctuation">,</span><span class="token builtin">bytes</span> <span class="token keyword">memory</span> headerSig<span class="token punctuation">)</span> whenNotPaused <span class="token keyword">public</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    ECCUtils<span class="token punctuation">.</span>Header <span class="token keyword">memory</span> header <span class="token operator">=</span> ECCUtils<span class="token punctuation">.</span><span class="token function">deserializeHeader</span><span class="token punctuation">(</span>rawHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Load ehereum cross chain data contract</span>
    IEthCrossChainData eccd <span class="token operator">=</span> <span class="token function">IEthCrossChainData</span><span class="token punctuation">(</span>EthCrossChainDataAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get stored consensus public key bytes of current poly chain epoch and deserialize Poly chain consensus public key bytes to address[]</span>
    <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> polyChainBKs <span class="token operator">=</span> ECCUtils<span class="token punctuation">.</span><span class="token function">deserializeKeepers</span><span class="token punctuation">(</span>eccd<span class="token punctuation">.</span><span class="token function">getCurEpochConPubKeyBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">uint256</span> curEpochStartHeight <span class="token operator">=</span> eccd<span class="token punctuation">.</span><span class="token function">getCurEpochStartHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">uint</span> n <span class="token operator">=</span> polyChainBKs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span>height <span class="token operator">&gt;=</span> curEpochStartHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// It&apos;s enough to verify rawHeader signature</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>ECCUtils<span class="token punctuation">.</span><span class="token function">verifySig</span><span class="token punctuation">(</span>rawHeader<span class="token punctuation">,</span> headerSig<span class="token punctuation">,</span> polyChainBKs<span class="token punctuation">,</span> n <span class="token operator">-</span> <span class="token punctuation">(</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Verify poly chain header signature failed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// We need to verify the signature of curHeader </span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>ECCUtils<span class="token punctuation">.</span><span class="token function">verifySig</span><span class="token punctuation">(</span>curRawHeader<span class="token punctuation">,</span> headerSig<span class="token punctuation">,</span> polyChainBKs<span class="token punctuation">,</span> n <span class="token operator">-</span> <span class="token punctuation">(</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Verify poly chain current epoch header signature failed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Then use curHeader.StateRoot and headerProof to verify rawHeader.CrossStateRoot</span>
        ECCUtils<span class="token punctuation">.</span>Header <span class="token keyword">memory</span> curHeader <span class="token operator">=</span> ECCUtils<span class="token punctuation">.</span><span class="token function">deserializeHeader</span><span class="token punctuation">(</span>curRawHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">bytes</span> <span class="token keyword">memory</span> proveValue <span class="token operator">=</span> ECCUtils<span class="token punctuation">.</span><span class="token function">MerkleProve</span><span class="token punctuation">(</span>headerProof<span class="token punctuation">,</span> curHeader<span class="token punctuation">.</span>blockRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>ECCUtils<span class="token punctuation">.</span><span class="token function">getHeaderHash</span><span class="token punctuation">(</span>rawHeader<span class="token punctuation">)</span> <span class="token operator">==</span> Utils<span class="token punctuation">.</span><span class="token function">bytesToBytes32</span><span class="token punctuation">(</span>proveValue<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;verify header proof failed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Through rawHeader.CrossStatesRoot, the toMerkleValue or cross chain msg can be verified and parsed from proof</span>
    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> toMerkleValueBs <span class="token operator">=</span> ECCUtils<span class="token punctuation">.</span><span class="token function">MerkleProve</span><span class="token punctuation">(</span>proof<span class="token punctuation">,</span> header<span class="token punctuation">.</span>crossStatesRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Parse the toMerkleValue struct and make sure the tx has not been processed, then mark this tx as processed</span>
    ECCUtils<span class="token punctuation">.</span>ToMerkleValue <span class="token keyword">memory</span> toMerkleValue <span class="token operator">=</span> ECCUtils<span class="token punctuation">.</span><span class="token function">deserializeMerkleValue</span><span class="token punctuation">(</span>toMerkleValueBs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token operator">!</span>eccd<span class="token punctuation">.</span><span class="token function">checkIfFromChainTxExist</span><span class="token punctuation">(</span>toMerkleValue<span class="token punctuation">.</span>fromChainID<span class="token punctuation">,</span> Utils<span class="token punctuation">.</span><span class="token function">bytesToBytes32</span><span class="token punctuation">(</span>toMerkleValue<span class="token punctuation">.</span>txHash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;the transaction has been executed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>eccd<span class="token punctuation">.</span><span class="token function">markFromChainTxExist</span><span class="token punctuation">(</span>toMerkleValue<span class="token punctuation">.</span>fromChainID<span class="token punctuation">,</span> Utils<span class="token punctuation">.</span><span class="token function">bytesToBytes32</span><span class="token punctuation">(</span>toMerkleValue<span class="token punctuation">.</span>txHash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Save crosschain tx exist failed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Ethereum ChainId is 2, we need to check the transaction is for Ethereum network</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>toMerkleValue<span class="token punctuation">.</span>makeTxParam<span class="token punctuation">.</span>toChainId <span class="token operator">==</span> chainId<span class="token punctuation">,</span> <span class="token string">&quot;This Tx is not aiming at this network!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Obtain the target contract, so that Ethereum cross chain manager contract can trigger the executation of cross chain tx on Ethereum side</span>
    <span class="token builtin">address</span> toContract <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">bytesToAddress</span><span class="token punctuation">(</span>toMerkleValue<span class="token punctuation">.</span>makeTxParam<span class="token punctuation">.</span>toContract<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// only invoke PreWhiteListed Contract and method For Now</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>whiteListContractMethodMap<span class="token punctuation">[</span>toContract<span class="token punctuation">]</span><span class="token punctuation">[</span>toMerkleValue<span class="token punctuation">.</span>makeTxParam<span class="token punctuation">.</span>method<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">&quot;Invalid to contract or method&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//TODO: check this part to make sure we commit the next line when doing local net UT test</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">_executeCrossChainTx</span><span class="token punctuation">(</span>toContract<span class="token punctuation">,</span> toMerkleValue<span class="token punctuation">.</span>makeTxParam<span class="token punctuation">.</span>method<span class="token punctuation">,</span> toMerkleValue<span class="token punctuation">.</span>makeTxParam<span class="token punctuation">.</span>args<span class="token punctuation">,</span> toMerkleValue<span class="token punctuation">.</span>makeTxParam<span class="token punctuation">.</span>fromContract<span class="token punctuation">,</span> toMerkleValue<span class="token punctuation">.</span>fromChainID<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Execute CrossChain Tx failed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Fire the cross chain event denoting the executation of cross chain tx is successful,</span>
    <span class="token comment">// and this tx is coming from other public chains to current Ethereum network</span>
    <span class="token keyword">emit</span> <span class="token function">VerifyHeaderAndExecuteTxEvent</span><span class="token punctuation">(</span>toMerkleValue<span class="token punctuation">.</span>fromChainID<span class="token punctuation">,</span> toMerkleValue<span class="token punctuation">.</span>makeTxParam<span class="token punctuation">.</span>toContract<span class="token punctuation">,</span> toMerkleValue<span class="token punctuation">.</span>txHash<span class="token punctuation">,</span> toMerkleValue<span class="token punctuation">.</span>makeTxParam<span class="token punctuation">.</span>txHash<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 
 *  @notice                       Dynamically invoke the target contract, trigger execution of cross-chain tx 
                                  on Ethereum side
 *  @param _toContract            the Ethereum Cross Chain Manager contract will invoke the target contract
 *  @param _method                At which method will be invoked within the target contract
 *  @param _args                  The parameter that will be passed into the target contract
 *  @param _fromContractAddr      From chain smart contract address
 *  @param _fromChainId           Indicate from which chain current cross-chain tx comes 
 *  @return                       true or false
*/</span>
<span class="token keyword">function</span> <span class="token function">_executeCrossChainTx</span><span class="token punctuation">(</span><span class="token builtin">address</span> _toContract<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> _method<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> _args<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> _fromContractAddr<span class="token punctuation">,</span> <span class="token builtin">uint64</span> _fromChainId<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// Ensure the target contract gonna be invoked is indeed a contract rather than a normal account address</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>Utils<span class="token punctuation">.</span><span class="token function">isContract</span><span class="token punctuation">(</span>_toContract<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;The passed in address is not a contract!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> returnData<span class="token punctuation">;</span>
    <span class="token builtin">bool</span> success<span class="token punctuation">;</span>

    <span class="token comment">// The returnData will be bytes32, the last byte must be 01;</span>
    <span class="token punctuation">(</span>success<span class="token punctuation">,</span> returnData<span class="token punctuation">)</span> <span class="token operator">=</span> _toContract<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span><span class="token builtin">bytes4</span><span class="token punctuation">(</span><span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>_method<span class="token punctuation">,</span> <span class="token string">&quot;(bytes,bytes,uint64)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> abi<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>_args<span class="token punctuation">,</span> _fromContractAddr<span class="token punctuation">,</span> _fromChainId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Ensure the executation is successful</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>success <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;EthCrossChain call business contract failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Ensure the returned value is true</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>returnData<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;No return value from business contract!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token builtin">bool</span> res<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> ZeroCopySource<span class="token punctuation">.</span><span class="token function">NextBool</span><span class="token punctuation">(</span>returnData<span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;EthCrossChain call business contract return is not true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>The <a href="../../GLOSSARY.html#relayer" class="glossary-term" title="A cross-chain information porter performs some of the most critical operations within the cross-chain. It acts as the medium of interaction between the side chain and the outside world.">relayer</a> should invoke this method. In some cases, users could invoke this method by themselves if they get the valid block information from Poly. </li>
<li>This method fetches and processes <strong>cross-chain transactions</strong>, finds the <strong>Merkle root of a transaction</strong> based on the block height (in the block header), and verifies the <strong>transaction&apos;s legitimacy</strong> using the transaction parameters.</li>
<li>After verifying the <a href="../../GLOSSARY.html#poly-chain" class="glossary-term" title="The relay chain in the cross-chain ecosystem. One of the crucial components of the cross-chain ecosystem. Each type of node is deployed and maintained by other individuals or organizations and has its unique governance and trust mechanism. The poly chain is responsible for connecting them, standardizing cross-chain data flow and interfaces, verifying the legitimacy of cross-chain data, etc.">Poly chain</a> block header and proof, you still need to check if the parameters <code>toContract</code> and <code>toMerkleValue.makeTxParam.method</code> have been listed in whitelists.</li>
<li>Then it will invoke the business logic contract deployed on the <a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a>. Invoking will be processed through the internal method <code>_executeCrossChainTx()</code>: <ul>
<li>This method is meant to invoke the target contract and trigger the execution of cross-chain tx on the <a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a>. </li>
<li>Firstly, you need to ensure that the target contract is waiting to be invoked a contract rather than a standard account address. </li>
<li>Then construct a target business logic contract method:  you need to <code>encodePacked</code> the <code>_method</code> and the input data format <code>&quot;(bytes,bytes,uint64)&quot;</code>. </li>
<li>Then it would <code>keccak256</code> the encoded string, using <code>bytes4</code> to take the first four bytes of the call data for a function call specifies the function to be called. </li>
<li>Parameter <code>_method</code> is from the <code>toMerkleValue</code>, which is parsed from <code>proof</code>. And the input parameters format is restricted as (bytes <code>_args</code>, bytes <code>_fromContractAddr</code>, uint64 <code>_fromChainId</code>). These two parts are encodePacked as a method call.  </li>
</ul>
</li>
<li>After calling the method, you need to check the return value. Only if the return value is true will the whole cross-chain transaction be executed successfully. </li>
</ul>
<p>To guarantee the safety of the CCM contract, we keep <strong>whitelists</strong> of contract addresses and methods to prevent invalid calls. Meanwhile, we also set <code>whiteLister</code> to manage these whitelists of the CCM contract. </p>
<p>Here is the <a href="https://github.com/polynetwork/eth-contracts/blob/master/contracts/core/cross_chain_manager/logic/EthCrossChainManager.sol#41" target="_blank">template</a> for adding a whitelist. We highly encourage developers to develop similar features of authority management in personal projects. </p>
<footer class="page-footer"><span class="copyright">Copyright &#xA9; 2022 PolyNetwork. All right reserved.</span><span class="footer-modification">Last modification date&#xFF1A;
2022-03-23 15:08:29
</span></footer>
                        
                    </section>
                    
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                </div>
            </div>
            
        </div>

        
        
        <a href="../relay_chain/relay_chain_development.html"
           class="navigation navigation-prev "
           aria-label="Previous page: Develop for Poly Chain">
            <i class="fa fa-angle-left"></i>
        </a>
        
        
        <a href="../relayer/relayer.html"
           class="navigation navigation-next "
           aria-label="Next page: Develop for Relayer">
            <i class="fa fa-angle-right"></i>
        </a>
        
        
        
    </div>
    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Develop for New Chain","level":"2.1.2","depth":2,"next":{"title":"Develop for Relayer","level":"2.1.3","depth":2,"path":"new_chain/relayer/relayer.md","ref":"new_chain/relayer/relayer.md","articles":[]},"previous":{"title":"Develop for Poly Chain","level":"2.1.1","depth":2,"path":"new_chain/relay_chain/relay_chain_development.md","ref":"new_chain/relay_chain/relay_chain_development.md","articles":[]},"dir":"ltr"},"config":{"plugins":["sectionx","-sharing","sharing-plus","theme-hqbook","flexible-linkcard","emphasize","flexible-alerts","lightbox","alerts","expandable-chapters","custom-favicon","tbfed-pagefooter","hide-element","-lunr","-search","search-pro","code","heading-anchors","-highlight","prism","prism-themes","livereload"],"styles":{"website":"styles/website.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright &copy 2022 PolyNetwork.","modify_label":"Last modification date：","modify_format":"YYYY-MM-DD HH:mm:ss"},"prism":{"css":["prismjs/themes/prism-okaidia.css"]},"emphasize":{},"livereload":{},"search-pro":{},"sharing-plus":{"qq":false,"all":["facebook","google","twitter","instapaper","linkedin","pocket","stumbleupon"],"douban":false,"facebook":true,"weibo":false,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":true,"messenger":false,"line":false,"vk":false,"pocket":true,"google":false,"viber":false,"stumbleupon":false,"qzone":false,"linkedin":false},"flexible-linkcard":{"hrefUrl":"../../demo/demo.html","imgClass":"","imgSrc":"../../images/home/logo.png","target":"_blank","title":"Converts blockquotes into beautiful linkcard, custom nice links"},"code":{"copyButtons":true},"hide-element":{"elements":[".gitbook-link"]},"fontsettings":{"theme":"night","family":"serif","size":2},"sectionx":{"tag":"b"},"heading-anchors":{},"favicon":"resources/favicon.ico","lightbox":{"jquery":true,"sameUuid":false},"prism-themes":{},"theme-hqbook":{"copyButtons":false,"copyLines":true,"dragSplitter":true,"favicon":"/resources/favicon.ico","flexible-linkcard":{"hrefUrl":"https://poly.network/#/","imgClass":"rect","imgSrc":"/resources/logo.png","target":"_blank","title":"flexible-linkcard"},"logo":"/resources/logo.png","search-placeholder":"Search...","hide-elements":[".summary .gitbook-link"]},"alerts":{},"custom-favicon":{},"flexible-alerts":{"danger":{"className":"danger","icon":"fa fa-ban","label":"Attention"},"note":{"className":"info","icon":"fa fa-info-circle","label":"Note"},"style":"callout","tip":{"className":"tip","icon":"fa fa-lightbulb-o","label":"Tip"},"warning":{"className":"warning","icon":"fa fa-exclamation-triangle","label":"Warning"}},"links":{"sidebar":{"Blog":"https://blog.csdn.net/ming_97y","Github":"https://github.com/jiangminggithub"}},"sharing":{"qq":false,"telegram":true,"youtube":true,"github":true,"douban":false,"facebook":false,"weibo":false,"discord":true,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":true,"messenger":false,"line":false,"vk":false,"medium":true,"pocket":false,"google":false,"viber":false,"stumbleupon":false,"email":true,"qzone":false,"linkedin":false},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"expandable-chapters":{}},"theme":"default","author":"PolyNetwork","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"introduction.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"lightbox":{"includeJQuery":false,"sameUuid":true,"options":{"resizeDuration":500,"wrapAround":false}},"variables":{"themeHqbook":{"nav":[{"url":"https://poly.network/","target":"_blank","name":"Home"},{"url":"https://bridge.poly.network/","target":"_blank","name":"Poly Bridge"},{"url":"https://explorer.poly.network/","target":"_blank","name":"Poly Explorer"}]}},"title":"","flexible-alerts":{"style":"callout","comment":{"label":"Comment","icon":"fa fa-comments","className":"info"}},"gitbook":"*","theme-default":{"showLevel":true}},"file":{"path":"new_chain/side_chain/contracts.md","mtime":"2022-03-23T07:08:29.837Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-03-23T07:16:45.293Z"},"basePath":"../..","book":{"language":""}})
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sectionx/sectionx.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing-plus/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-flexible-linkcard/flexible-linkcard.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-flexible-alerts/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lightbox/js/lightbox.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-alerts/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-hide-element/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/1.2.1/anchor.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-heading-anchors/anchor-style.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-theme-hqbook/theme.js"></script>
        
    

    </body>
</html>

