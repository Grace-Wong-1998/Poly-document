
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Guidelines for Developing · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="PolyNetwork">
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-sectionx/sectionx.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-sharing-plus/all.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-sharing-plus/style.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-flexible-linkcard/flexible-linkcard.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-emphasize/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-flexible-alerts/style.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-lightbox/css/lightbox.min.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-alerts/style.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-prism/prism-okaidia.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-theme-hqbook/theme.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../../styles/website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="launch.html" />
    
    
    <link rel="prev" href="readme.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="header-inner">
        <!-- LOGO -->
        <div class="logo">
            <img src="" alt="logo">
        </div>
        <span class="title"></span>

        <!-- Search -->
        
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>


        <!-- Nav -->
        <ul class="header-nav">
            <li>
                <a href="https://poly.network/" target="_blank">Home</a>
            </li><li>
                <a href="https://bridge.poly.network/" target="_blank">Poly Bridge</a>
            </li><li>
                <a href="https://explorer.poly.network/" target="_blank">Poly Explorer</a>
            </li>
        </ul>
    </div>

    <div class="book-summary">
        <!--<div class="book-summary-title">文档目录</div>-->
        
        
        <nav role="navigation">
            


<ul class="summary">
    
    

    

    
        
        <li class="header">Introduction</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    About Poly Network
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../guideline.html">
            
                <a href="../../guideline.html">
            
                    
                    Guidelines for Reading
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Development</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../../new_chain/readme.html">
            
                <a href="../../new_chain/readme.html">
            
                    
                    Connect New Chains
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="../../new_chain/relay_chain/relay_chain_development.html">
            
                <a href="../../new_chain/relay_chain/relay_chain_development.html">
            
                    
                    Develop for Poly Chain
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="../../new_chain/side_chain/contracts.html">
            
                <a href="../../new_chain/side_chain/contracts.html">
            
                    
                    Develop for New Chain
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="../../new_chain/relayer/relayer.html">
            
                <a href="../../new_chain/relayer/relayer.html">
            
                    
                    Develop for Relayer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4" data-path="../../new_chain/launch_and_test/launch.html">
            
                <a href="../../new_chain/launch_and_test/launch.html">
            
                    
                    Test and Launch
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../integrate_bridge/readme.html">
            
                <a href="../integrate_bridge/readme.html">
            
                    
                    Build New Bridges
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.2.1" data-path="../integrate_bridge/bridge.html">
            
                <a href="../integrate_bridge/bridge.html">
            
                    
                    API
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../integrate_assets/readme.html">
            
                <a href="../integrate_assets/readme.html">
            
                    
                    Import New Assets
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.3.1" data-path="../integrate_assets/token.html">
            
                <a href="../integrate_assets/token.html">
            
                    
                    Import Token
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.2" data-path="../integrate_assets/nft.html">
            
                <a href="../integrate_assets/nft.html">
            
                    
                    Import NFT
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="readme.html">
            
                <a href="readme.html">
            
                    
                    Customize Business Logic Contracts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="2.4.1" data-path="Customizing Business Logic Contract.html">
            
                <a href="Customizing Business Logic Contract.html">
            
                    
                    Guidelines for Developing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4.2" data-path="launch.html">
            
                <a href="launch.html">
            
                    
                    Test and Launch
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">User Manuals</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../../Core_Smart_Contract/User_Manuals/Token_Transaction.html">
            
                <a href="../../Core_Smart_Contract/User_Manuals/Token_Transaction.html">
            
                    
                    Token Transaction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../../Core_Smart_Contract/User_Manuals/NFT_Transaction.html">
            
                <a href="../../Core_Smart_Contract/User_Manuals/NFT_Transaction.html">
            
                    
                    NFT Transaction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../../Core_Smart_Contract/User_Manuals/Transaction_Acceleration.html">
            
                <a href="../../Core_Smart_Contract/User_Manuals/Transaction_Acceleration.html">
            
                    
                    Transaction Acceleration
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Appendix</li>
        
        
    
        <li class="chapter " data-level="4.1" >
            
                <span>
            
                    
                    Contracts
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="../../Core_Smart_Contract/Contract/CCD.html">
            
                <a href="../../Core_Smart_Contract/Contract/CCD.html">
            
                    
                    CCD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="../../Core_Smart_Contract/Contract/CCM.html">
            
                <a href="../../Core_Smart_Contract/Contract/CCM.html">
            
                    
                    CCM
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3" data-path="../../Core_Smart_Contract/Contract/CCMP.html">
            
                <a href="../../Core_Smart_Contract/Contract/CCMP.html">
            
                    
                    CCMP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4" data-path="../../Core_Smart_Contract/Contract/LockProxy.html">
            
                <a href="../../Core_Smart_Contract/Contract/LockProxy.html">
            
                    
                    LockProxy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5" data-path="../../Core_Smart_Contract/Contract/NFTLockProxy.html">
            
                <a href="../../Core_Smart_Contract/Contract/NFTLockProxy.html">
            
                    
                    NFTLockProxy
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../../Core_Smart_Contract/Nodes/Nodes.html">
            
                <a href="../../Core_Smart_Contract/Nodes/Nodes.html">
            
                    
                    Nodes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../../Core_Smart_Contract/Chain_ID/Chain_ID.html">
            
                <a href="../../Core_Smart_Contract/Chain_ID/Chain_ID.html">
            
                    
                    Chain ID
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="../../GLOSSARY.html">
            
                <a href="../../GLOSSARY.html">
            
                    
                    Glossary
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">FAQ</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../../FAQ/template.html">
            
                <a href="../../FAQ/template.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


        </nav>
        
        
    </div>

    <!-- Content nav -->
    <div class="book-anchor">
        <!--<div class="book-anchor-title">在这篇文章中:</div>-->
        <div class="book-anchor-body">

        </div>
    </div>

    <div class="book-body">
        
        <div class="body-inner">
            
            

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Guidelines for Developing</a>
    </h1>
</div>




            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                    
<div id="book-search-results">
    <div class="search-noresults">
    
                    <section class="normal markdown-section">
                        
                        <h1 align="center" id="guidelines-for-developing">Guidelines for Developing</h1>

<p>Chains must and must only be deployed with one CCM contract to implement cross-chain features. And for normal running, all the business logic contracts have to interconnect with the CCM contract via the interfaces offered by the CCM contract. See the following for a detailed description or reference to the complete code of the CCM contract.</p>
<blockquote>
<p>[!Note|style:flat|label:Notice]
To implement cross-chain features, you need to ensure that the cross-chain methods in your business logic contracts have authorized CCM of Poly.</p>
</blockquote>
<h3 id="step1-mapping-asset">Step1. Mapping asset</h3>
<p>Except for verifying the existence of transactions through the CCM contract, the business logic contract needs to ensure the accuracy of the asset relationship in the transaction. 
Therefore, the business contract should maintain both the <strong>asset mapping</strong> and <strong>business logic contract mapping</strong>. 
Asset hash is mapped from the <a href="../../GLOSSARY.html#source-chain" class="glossary-term" title="A public chain corresponds to the target chain where a particular asset firstly appears.">source chain</a> to the <a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a>, and <a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a> ID is mapped to the business logic contract address on the <a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a>.</p>
<h4 id="example">Example:</h4>
<p>The asset mapping relationship stored in the business logic contract will help complete transaction data. Binding actions also prevent the wrong input from users, leading to the transfer of assets to the incorrect asset contract address.</p>
<pre class="language-"><code class="lang-solidity"><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.5.0</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">&quot;./../../libs/ownership/Ownable.sol&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">LockProxy</span> <span class="token keyword">is</span> Ownable <span class="token punctuation">{</span>
    <span class="token builtin">address</span> <span class="token keyword">public</span> managerProxyContract<span class="token punctuation">;</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint64</span> <span class="token operator">=&gt;</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token keyword">public</span> proxyHashMap<span class="token punctuation">;</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint64</span> <span class="token operator">=&gt;</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">public</span> assetHashMap<span class="token punctuation">;</span>

    <span class="token comment">// toChainId: the target chain id</span>
    <span class="token comment">// targetProxyHash: the address of business logic contract on target chain</span>
    <span class="token keyword">function</span> <span class="token function">bindProxyHash</span><span class="token punctuation">(</span><span class="token builtin">uint64</span> toChainId<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> targetProxyHash<span class="token punctuation">)</span> onlyOwner <span class="token keyword">public</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        proxyHashMap<span class="token punctuation">[</span>toChainId<span class="token punctuation">]</span> <span class="token operator">=</span> targetProxyHash<span class="token punctuation">;</span>
        <span class="token keyword">emit</span> <span class="token function">BindProxyEvent</span><span class="token punctuation">(</span>toChainId<span class="token punctuation">,</span> targetProxyHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// fromAssetHash: asset hash on source chain </span>
    <span class="token comment">// toAssetHash: asset hash on target chain</span>
    <span class="token keyword">function</span> <span class="token function">bindAssetHash</span><span class="token punctuation">(</span><span class="token builtin">address</span> fromAssetHash<span class="token punctuation">,</span> <span class="token builtin">uint64</span> toChainId<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> toAssetHash<span class="token punctuation">)</span> onlyOwner <span class="token keyword">public</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        assetHashMap<span class="token punctuation">[</span>fromAssetHash<span class="token punctuation">]</span><span class="token punctuation">[</span>toChainId<span class="token punctuation">]</span> <span class="token operator">=</span> toAssetHash<span class="token punctuation">;</span>
        <span class="token keyword">emit</span> <span class="token function">BindAssetEvent</span><span class="token punctuation">(</span>fromAssetHash<span class="token punctuation">,</span> toChainId<span class="token punctuation">,</span> toAssetHash<span class="token punctuation">,</span> <span class="token function">getBalanceFor</span><span class="token punctuation">(</span>fromAssetHash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="step2-requesting-transaction">Step2. Requesting transaction</h3>
<p>This interface creates cross-chain transactions invoked by business logic contracts when a cross-chain function is carried out in the logic contract.</p>
<pre class="language-"><code class="lang-solidity"><span class="token comment">/*  
 *  @param toChainId              The target chain id
 *  @param toAddress              The address in bytes format to receive the same amount of tokens in the target chain
 *  @param toContract             Target smart contract address in bytes in the target blockchain
 *  @param txData                 Transaction data for target chain, include toAssetHash, toAddress, amount
 *  @return                       true or false 
*/</span>
<span class="token keyword">function</span> <span class="token function">crossChain</span><span class="token punctuation">(</span><span class="token builtin">uint64</span> toChainId<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> toContract<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> method<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> txData<span class="token punctuation">)</span> whenNotPaused <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span>
</code></pre>
<ul>
<li>This method constructs the <code>rawParam</code>, which contains <strong>transaction hash</strong>, <code>msg.sender</code>, <strong><a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a> ID</strong>, <strong>business logic contract</strong> on <a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a>, the <strong>target method</strong> to be invoked, and the <strong>serialized transaction data</strong> has been already constructed in the business logic contract. </li>
<li>Then put the hash of <code>rawParam</code> into storage to prove the cross-chain transaction.</li>
</ul>
<h4 id="example">Example:</h4>
<pre class="language-"><code class="lang-solidity"><span class="token comment">/*  
 *  @param fromAssetHash     The asset address in the current chain
 *  @param toChainId         The target chain id
 *  @param toAddress         The address in bytes format to receive the same amount of tokens in the target chain 
 *  @param amount            The number of tokens to be crossed from Ethereum to the chain with chainId
*/</span>
<span class="token keyword">function</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token builtin">address</span> fromAssetHash<span class="token punctuation">,</span> <span class="token builtin">uint64</span> toChainId<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> toAddress<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">payable</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>amount <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;amount cannot be zero!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">_transferToContract</span><span class="token punctuation">(</span>fromAssetHash<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;transfer asset from fromAddress to lock_proxy contract failed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> toAssetHash <span class="token operator">=</span> assetHashMap<span class="token punctuation">[</span>fromAssetHash<span class="token punctuation">]</span><span class="token punctuation">[</span>toChainId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>toAssetHash<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;empty illegal toAssetHash&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    TxArgs <span class="token keyword">memory</span> txArgs <span class="token operator">=</span> <span class="token function">TxArgs</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        toAssetHash<span class="token punctuation">:</span> toAssetHash<span class="token punctuation">,</span>
        toAddress<span class="token punctuation">:</span> toAddress<span class="token punctuation">,</span>
        amount<span class="token punctuation">:</span> amount
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> txData <span class="token operator">=</span> <span class="token function">_serializeTxArgs</span><span class="token punctuation">(</span>txArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    IEthCrossChainManagerProxy eccmp <span class="token operator">=</span> <span class="token function">IEthCrossChainManagerProxy</span><span class="token punctuation">(</span>managerProxyContract<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">address</span> eccmAddr <span class="token operator">=</span> eccmp<span class="token punctuation">.</span><span class="token function">getEthCrossChainManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    IEthCrossChainManager eccm <span class="token operator">=</span> <span class="token function">IEthCrossChainManager</span><span class="token punctuation">(</span>eccmAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> toProxyHash <span class="token operator">=</span> proxyHashMap<span class="token punctuation">[</span>toChainId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>toProxyHash<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;empty illegal toProxyHash&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>eccm<span class="token punctuation">.</span><span class="token function">crossChain</span><span class="token punctuation">(</span>toChainId<span class="token punctuation">,</span> toProxyHash<span class="token punctuation">,</span> <span class="token string">&quot;unlock&quot;</span><span class="token punctuation">,</span> txData<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;EthCrossChainManager crossChain executed error!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">emit</span> <span class="token function">LockEvent</span><span class="token punctuation">(</span>fromAssetHash<span class="token punctuation">,</span> <span class="token function">_msgSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> toChainId<span class="token punctuation">,</span> toAssetHash<span class="token punctuation">,</span> toAddress<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>This function is invoked by <strong>users</strong>. Users can request a cross-chain transaction through the dApps, which works in the <a href="../../GLOSSARY.html#source-chain" class="glossary-term" title="A public chain corresponds to the target chain where a particular asset firstly appears.">source chain</a>. Then the business logic contract will get the transaction information involving <strong>asset contract address</strong> on <a href="../../GLOSSARY.html#source-chain" class="glossary-term" title="A public chain corresponds to the target chain where a particular asset firstly appears.">source chain</a>, <strong><a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a> ID</strong>, <strong>target address,</strong> and <strong>amount of token</strong> to be transferred. By calling this method, the business logic contract will <strong>lock</strong> a certain amount to asset contract;</li>
<li>Then the transaction data will be packed, which invokes the CCM contract. </li>
<li>The CCM contract transfers the parameters of transaction data to the <a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a> based on block generation on the <a href="../../GLOSSARY.html#source-chain" class="glossary-term" title="A public chain corresponds to the target chain where a particular asset firstly appears.">source chain</a>;</li>
<li>The serialized <strong>transaction data</strong>, chain ID<strong>, </strong>business logic contract address** of <a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a>, and the method needing to be called on <a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a> will be sent through <code>crossChain()</code> in the CCM contract.</li>
</ul>
<h3 id="step3-verifying-and-executing">Step3. Verifying and executing</h3>
<p>This method is invoked by the <a href="../../GLOSSARY.html#relayer" class="glossary-term" title="A cross-chain information porter performs some of the most critical operations within the cross-chain. It acts as the medium of interaction between the side chain and the outside world.">relayer</a>, but in some cases, users could also invoke this method by themselves if they get the valid block information from Poly.</p>
<pre class="language-"><code class="lang-solidity"><span class="token comment">/*  
 *  @param proof                  Poly chain transaction Merkle proof
 *  @param rawHeader              The header containing crossStateRoot to verify the above tx Merkle proof
 *  @param headerProof            The header Merkle proof used to verify rawHeader
 *  @param curRawHeader           Any header in current epoch consensus of Poly chain
 *  @param headerSig              The converted signature variable for solidity derived from Poly chain consensus nodes&apos; signature 
 *                                used to verify the validity of curRawHeader
 *  @return                       true or false
*/</span>
<span class="token keyword">function</span> <span class="token function">verifyHeaderAndExecuteTx</span><span class="token punctuation">(</span><span class="token builtin">bytes</span> <span class="token keyword">memory</span> proof<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> rawHeader<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> headerProof<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> curRawHeader<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> headerSig<span class="token punctuation">)</span> whenNotPaused <span class="token keyword">public</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span>
</code></pre>
<ul>
<li>This method fetches and processes <strong>cross-chain transactions</strong>, finds the <strong>Merkle root</strong> of a transaction based on the block height (in the block header), and verifies the <strong>transaction&apos;s legitimacy</strong> using the transaction parameters.</li>
<li>After verifying the <a href="../../GLOSSARY.html#poly-chain" class="glossary-term" title="The relay chain in the cross-chain ecosystem. One of the crucial components of the cross-chain ecosystem. Each type of node is deployed and maintained by other individuals or organizations and has its unique governance and trust mechanism. The poly chain is responsible for connecting them, standardizing cross-chain data flow and interfaces, verifying the legitimacy of cross-chain data, etc.">Poly chain</a> block header and proof, it will invoke the business logic contract deployed on the <a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a>. Invoking will be processed through the internal method <code>_executeCrossChainTx()</code>: <ul>
<li>This method is meant to invoke the target contract and trigger the execution of cross-chain tx on the <a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a>. </li>
<li>Firstly, you need to ensure that the target contract is waiting to be invoked a contract rather than a standard account address. </li>
<li>Then construct a method calling on target business logic contract: <ol>
<li>You need to <code>encodePacked</code> the <code>_method</code> and the format of input data <code>&quot;(bytes,bytes,uint64)&quot;</code>;</li>
<li>Then it would <code>keccak256</code> the encoded string, using <code>bytes4</code> to take the first four bytes of the call data for a function call specifies the function to be called. </li>
<li>Parameter <code>_method</code> is from the <code>toMerkleValue</code>, which is parsed from <code>proof</code>. And the input parameters format is restricted as (bytes <code>_args</code>, bytes <code>_fromContractAddr</code>, uint64 <code>_fromChainId</code>). These two parts are <code>encodePacked</code> as a method call.  </li>
</ol>
</li>
<li>After calling the method, you need to check the return value. Only if the return value is true will the whole cross-chain transaction be executed successfully. </li>
</ul>
</li>
</ul>
<h4 id="example">Example:</h4>
<pre class="language-"><code class="lang-solidity"><span class="token comment">/*  
 *  @param argsBs            The argument bytes received by the lock proxy contract on source chain, 
 *                           need to be deserialized based on the way of serialization in the 
 *                           lock proxy contract on source chain.
 *  @param fromContractAddr  The source chain contract address
 *  @param fromChainId       The source chain id
*/</span>
<span class="token keyword">function</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token builtin">bytes</span> <span class="token keyword">memory</span> argsBs<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> fromContractAddr<span class="token punctuation">,</span> <span class="token builtin">uint64</span> fromChainId<span class="token punctuation">)</span> onlyManagerContract <span class="token keyword">public</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TxArgs <span class="token keyword">memory</span> args <span class="token operator">=</span> <span class="token function">_deserializeTxArgs</span><span class="token punctuation">(</span>argsBs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>fromContractAddr<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;from proxy contract address cannot be empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>Utils<span class="token punctuation">.</span><span class="token function">equalStorage</span><span class="token punctuation">(</span>proxyHashMap<span class="token punctuation">[</span>fromChainId<span class="token punctuation">]</span><span class="token punctuation">,</span> fromContractAddr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;From Proxy contract address error!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">require</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>toAssetHash<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;toAssetHash cannot be empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">address</span> toAssetHash <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">bytesToAddress</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>toAssetHash<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">require</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>toAddress<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;toAddress cannot be empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">address</span> toAddress <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">bytesToAddress</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>toAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">_transferFromContract</span><span class="token punctuation">(</span>toAssetHash<span class="token punctuation">,</span> toAddress<span class="token punctuation">,</span> args<span class="token punctuation">.</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;transfer asset from lock_proxy contract to toAddress failed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">emit</span> <span class="token function">UnlockEvent</span><span class="token punctuation">(</span>toAssetHash<span class="token punctuation">,</span> toAddress<span class="token punctuation">,</span> args<span class="token punctuation">.</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>This function is invoked by the <strong>CCM contract</strong>. It deserializes the transaction data and invokes the asset contract to release the tokens to the target address.</li>
<li><code>verifyHeaderAndExecuteTx()</code> in CCM contract determines the <strong>legitimacy</strong> of cross-chain transaction information and resolves the parameters of transaction data from the <a href="../../GLOSSARY.html#poly-chain" class="glossary-term" title="The relay chain in the cross-chain ecosystem. One of the crucial components of the cross-chain ecosystem. Each type of node is deployed and maintained by other individuals or organizations and has its unique governance and trust mechanism. The poly chain is responsible for connecting them, standardizing cross-chain data flow and interfaces, verifying the legitimacy of cross-chain data, etc.">Poly chain</a> transaction Merkle proof and <code>crossStateRoot</code> contained in the block header. </li>
<li>After verification through Poly, the packed transaction data could be executed on the <a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a>.</li>
<li>Then call the function <code>unlock()</code> to deserialize the transaction data, transfer a certain amount of token to the target address on the <a href="../../GLOSSARY.html#target-chain" class="glossary-term" title="A public chain corresponds to the source chain on which we want to cross an asset and issue a new token.">target chain</a>, and complete the cross-chain contract invocation.</li>
</ul>
<footer class="page-footer"><span class="copyright">Copyright &#xA9; 2022 PolyNetwork. All right reserved.</span><span class="footer-modification">Last modification date&#xFF1A;
2022-03-23 15:13:10
</span></footer>
                        
                    </section>
                    
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                </div>
            </div>
            
        </div>

        
        
        <a href="readme.html"
           class="navigation navigation-prev "
           aria-label="Previous page: Customize Business Logic Contracts">
            <i class="fa fa-angle-left"></i>
        </a>
        
        
        <a href="launch.html"
           class="navigation navigation-next "
           aria-label="Next page: Test and Launch">
            <i class="fa fa-angle-right"></i>
        </a>
        
        
        
    </div>
    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Guidelines for Developing","level":"2.4.1","depth":2,"next":{"title":"Test and Launch","level":"2.4.2","depth":2,"path":"new_product/integrate_contracts/launch.md","ref":"new_product/integrate_contracts/launch.md","articles":[]},"previous":{"title":"Customize Business Logic Contracts","level":"2.4","depth":1,"path":"new_product/integrate_contracts/readme.md","ref":"new_product/integrate_contracts/readme.md","articles":[{"title":"Guidelines for Developing","level":"2.4.1","depth":2,"path":"new_product/integrate_contracts/Customizing Business Logic Contract.md","ref":"new_product/integrate_contracts/Customizing Business Logic Contract.md","articles":[]},{"title":"Test and Launch","level":"2.4.2","depth":2,"path":"new_product/integrate_contracts/launch.md","ref":"new_product/integrate_contracts/launch.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":["sectionx","-sharing","sharing-plus","theme-hqbook","flexible-linkcard","emphasize","flexible-alerts","lightbox","alerts","expandable-chapters","custom-favicon","tbfed-pagefooter","hide-element","-lunr","-search","search-pro","code","heading-anchors","-highlight","prism","prism-themes","livereload"],"styles":{"website":"styles/website.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright &copy 2022 PolyNetwork.","modify_label":"Last modification date：","modify_format":"YYYY-MM-DD HH:mm:ss"},"prism":{"css":["prismjs/themes/prism-okaidia.css"]},"emphasize":{},"livereload":{},"search-pro":{},"sharing-plus":{"qq":false,"all":["facebook","google","twitter","instapaper","linkedin","pocket","stumbleupon"],"douban":false,"facebook":true,"weibo":false,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":true,"messenger":false,"line":false,"vk":false,"pocket":true,"google":false,"viber":false,"stumbleupon":false,"qzone":false,"linkedin":false},"flexible-linkcard":{"hrefUrl":"../../demo/demo.html","imgClass":"","imgSrc":"../../images/home/logo.png","target":"_blank","title":"Converts blockquotes into beautiful linkcard, custom nice links"},"code":{"copyButtons":true},"hide-element":{"elements":[".gitbook-link"]},"fontsettings":{"theme":"night","family":"serif","size":2},"sectionx":{"tag":"b"},"heading-anchors":{},"favicon":"resources/favicon.ico","lightbox":{"jquery":true,"sameUuid":false},"prism-themes":{},"theme-hqbook":{"copyButtons":false,"copyLines":true,"dragSplitter":true,"favicon":"/resources/favicon.ico","flexible-linkcard":{"hrefUrl":"https://poly.network/#/","imgClass":"rect","imgSrc":"/resources/logo.png","target":"_blank","title":"flexible-linkcard"},"logo":"/resources/logo.png","search-placeholder":"Search...","hide-elements":[".summary .gitbook-link"]},"alerts":{},"custom-favicon":{},"flexible-alerts":{"danger":{"className":"danger","icon":"fa fa-ban","label":"Attention"},"note":{"className":"info","icon":"fa fa-info-circle","label":"Note"},"style":"callout","tip":{"className":"tip","icon":"fa fa-lightbulb-o","label":"Tip"},"warning":{"className":"warning","icon":"fa fa-exclamation-triangle","label":"Warning"}},"links":{"sidebar":{"Blog":"https://blog.csdn.net/ming_97y","Github":"https://github.com/jiangminggithub"}},"sharing":{"qq":false,"telegram":true,"youtube":true,"github":true,"douban":false,"facebook":false,"weibo":false,"discord":true,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":true,"messenger":false,"line":false,"vk":false,"medium":true,"pocket":false,"google":false,"viber":false,"stumbleupon":false,"email":true,"qzone":false,"linkedin":false},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"expandable-chapters":{}},"theme":"default","author":"PolyNetwork","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"introduction.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"lightbox":{"includeJQuery":false,"sameUuid":true,"options":{"resizeDuration":500,"wrapAround":false}},"variables":{"themeHqbook":{"nav":[{"url":"https://poly.network/","target":"_blank","name":"Home"},{"url":"https://bridge.poly.network/","target":"_blank","name":"Poly Bridge"},{"url":"https://explorer.poly.network/","target":"_blank","name":"Poly Explorer"}]}},"title":"","flexible-alerts":{"style":"callout","comment":{"label":"Comment","icon":"fa fa-comments","className":"info"}},"gitbook":"*","theme-default":{"showLevel":true}},"file":{"path":"new_product/integrate_contracts/Customizing Business Logic Contract.md","mtime":"2022-03-23T07:13:10.933Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-03-23T07:16:45.293Z"},"basePath":"../..","book":{"language":""}})
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sectionx/sectionx.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing-plus/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-flexible-linkcard/flexible-linkcard.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-flexible-alerts/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lightbox/js/lightbox.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-alerts/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-hide-element/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/1.2.1/anchor.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-heading-anchors/anchor-style.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-theme-hqbook/theme.js"></script>
        
    

    </body>
</html>

